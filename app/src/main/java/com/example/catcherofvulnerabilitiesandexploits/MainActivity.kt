package com.example.catcherofvulnerabilitiesandexploits

import android.os.Bundle
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.GoogleMap
import com.google.android.gms.maps.OnMapReadyCallback
import com.google.android.gms.maps.SupportMapFragment
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.MarkerOptions
import com.google.android.material.appbar.MaterialToolbar
import com.google.android.material.floatingactionbutton.FloatingActionButton
import retrofit2.Call
import retrofit2.Callback
import retrofit2.Response
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory


class MainActivity : AppCompatActivity(), OnMapReadyCallback {

    private val cveShelf = CVEShelf()
    private val cnaShelf = CNAShelf()

    private val retrofit = Retrofit.Builder()
        .addConverterFactory(GsonConverterFactory.create())
        .baseUrl("https://app-f25a0629-b7d6-4dc2-897b-fd8fb1987bf4.cleverapps.io")
        .build()

    private val cveService = retrofit.create(CveService::class.java)
    private val cnaService = retrofit.create(CnaService::class.java)

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        cveService.getAllCves()
            .enqueue(object : Callback<List<CVE>> {
                override fun onResponse(
                    call: Call<List<CVE>>,
                    response: Response<List<CVE>>
                ) {
                    val allCves: List<CVE> = response.body()!!
                    for (cve in allCves) {
                        cveShelf.addCVE(cve)
                    }
                    displayCVEListFragment()
                }

                override fun onFailure(call: Call<List<CVE>>, t: Throwable) {
                    Toast.makeText(this@MainActivity, t.message, Toast.LENGTH_SHORT).show()
                }
            })

        cnaService.getAllCnas()
            .enqueue(object : Callback<List<CNA>> {
                override fun onResponse(
                    call: Call<List<CNA>>,
                    response: Response<List<CNA>>
                ) {
                    val allCnas: List<CNA> = response.body()!!
                    for (cna in allCnas) {
                        cnaShelf.addCNA(cna)
                    }
                }

                override fun onFailure(call: Call<List<CNA>>, t: Throwable) {
                    Toast.makeText(this@MainActivity, t.message, Toast.LENGTH_SHORT).show()
                }
            })

        val toolbar = findViewById<MaterialToolbar>(R.id.toolbar)

        val listButton = toolbar.findViewById<FloatingActionButton>(R.id.listButton)
        listButton.setOnClickListener {
            displayCVEListFragment()
        }

        val mapsButton = toolbar.findViewById<FloatingActionButton>(R.id.mapsButton)
        mapsButton.setOnClickListener {
            displayMapsFragment()
        }

        val infoButton = toolbar.findViewById<FloatingActionButton>(R.id.infoButton)
        infoButton.setOnClickListener {
            displayInfoFragment()
        }
    }

    override fun onMapReady(gmap: GoogleMap) {
        for (cna in cnaShelf.getAllCNAs()) {
            val cnaLocation = LatLng(cna.location.latitude, cna.location.longitude)
            gmap.addMarker(
                MarkerOptions()
                    .position(cnaLocation)
                    .title(cna.partner)
                    .snippet(cna.scope)
            )
        }
    }

    private fun displayCVEListFragment() {
        val fragmentTransaction = supportFragmentManager.beginTransaction()
        val fragment = CVEListFragment.newInstance(cveShelf.getAllCVEs())
        fragmentTransaction.replace(R.id.a_main_lyt_fragment_container, fragment)
        fragmentTransaction.commit()
    }

    private fun displayInfoFragment() {
        val fragmentTransaction = supportFragmentManager.beginTransaction()
        val fragment = InfoFragment.newInstance()
        fragmentTransaction.replace(R.id.a_main_lyt_fragment_container, fragment)
        fragmentTransaction.commit()
    }

    private fun displayMapsFragment() {
        val fragmentTransaction = supportFragmentManager.beginTransaction()
        val fragment = SupportMapFragment.newInstance()
        fragment.getMapAsync(this)
        fragmentTransaction.replace(R.id.a_main_lyt_fragment_container, fragment)
        fragmentTransaction.commit()
    }
}
